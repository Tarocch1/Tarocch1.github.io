<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <title>Go embed 简介</title>
    <link rel="stylesheet" href="/assets/css/normalize.css" />
    <link rel="stylesheet" href="/assets/css/wysiwyg.css" />
    <link rel="stylesheet" href="/assets/css/prism.css" />
    <link rel="stylesheet" href="/assets/css/prism-line-numbers.css" />
    <link rel="stylesheet" href="/assets/css/style.css" />
  </head>
  <body>
    <main>
      <div class="wysiwyg"><h1 id="go-embed-简介">Go embed 简介 <a class="header-anchor" href="#go-embed-简介" aria-hidden="true">¶</a></h1>
<p>在刚刚发布的 Go 1.16 版本更新中，加入了 <code>embed</code> 功能，可以将静态资源文件直接打包到二进制可执行文件中，真正实现单个二进制文件部署。这篇文章主要简单地介绍一下 <code>embed</code> 的用法。</p>
<h2 id="引入文件">引入文件 <a class="header-anchor" href="#引入文件" aria-hidden="true">¶</a></h2>
<h3 id="引入单个文件">引入单个文件 <a class="header-anchor" href="#引入单个文件" aria-hidden="true">¶</a></h3>
<p>我们可以直接将单个资源文件作为字符串、字节切片或者文件系统引入到代码中：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"embed"</span>

<span class="token comment">//go:embed hello.txt</span>
<span class="token keyword">var</span> s <span class="token builtin">string</span>

<span class="token comment">//go:embed hello.txt</span>
<span class="token keyword">var</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>

<span class="token comment">//go:embed hello.txt</span>
<span class="token keyword">var</span> f embed<span class="token punctuation">.</span>FS
</code></pre>
<h3 id="引入文件夹">引入文件夹 <a class="header-anchor" href="#引入文件夹" aria-hidden="true">¶</a></h3>
<p>也可以引入一整个文件夹，但是，文件夹只能以文件系统的形式引入：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"embed"</span>

<span class="token comment">//go:embed html</span>
<span class="token keyword">var</span> content embed<span class="token punctuation">.</span>FS
</code></pre>
<h3 id="说明">说明 <a class="header-anchor" href="#说明" aria-hidden="true">¶</a></h3>
<p>使用相对路径引入文件，相对路径的根路径是 Go 源代码所在的文件夹。</p>
<p>文件或文件夹的名称可以使用通配符 <code>*</code>，表示同时引入多个文件或文件夹下的全部文件，默认情况下，任何以 <code>.</code> 或 <code>_</code> 开头的文件或文件夹不会被引入，但使用通配符后将无视这一规则。</p>
<p><code>go:embed</code> 指令后可以接多个文件以及文件夹，这个指令本身也可以连续出现多次。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"embed"</span>

<span class="token comment">//go:embed image/* template/*</span>
<span class="token comment">//go:embed html/index.html</span>
<span class="token keyword">var</span> content embed<span class="token punctuation">.</span>FS
</code></pre>
<h2 id="使用文件">使用文件 <a class="header-anchor" href="#使用文件" aria-hidden="true">¶</a></h2>
<p>引入文件后就可以使用文件，<code>embed.FS</code> 文件系统是一种只读的文件系统，只提供了以下三种 API：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f FS<span class="token punctuation">)</span> <span class="token function">Open</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span>File<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f FS<span class="token punctuation">)</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f FS<span class="token punctuation">)</span> <span class="token function">ReadDir</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>fs<span class="token punctuation">.</span>DirEntry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>分别用来打开文件、读文件以及读文件夹。</p>
<h2 id="应用">应用 <a class="header-anchor" href="#应用" aria-hidden="true">¶</a></h2>
<p><code>embed</code> 可以很好地将静态的网页文件嵌入二进制可执行文件中。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"embed"</span>
	<span class="token string">"io/fs"</span>
	<span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token comment">//go:embed html</span>
<span class="token keyword">var</span> context embed<span class="token punctuation">.</span>FS

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	htmlFS<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fs<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"html"</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">FileServer</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">FS</span><span class="token punctuation">(</span>htmlFS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":80"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><a href="/">返回首页</a></p>
</div>
    </main>
    <footer>
      <div class="time">2021-03-03 22:58:48</div>
    </footer>
  </body>
</html>
